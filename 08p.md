Untitled
================
Yoo Ri Hwang
3/28/2022

## Overview

In this project, I tried SEM.. like licking the surface of the SEM.

.

Also, I referred many materials (see the readme file).

portfolio 8 for ds4p

main theme: Structure equation modeling

Reference1:
<https://quantdev.ssri.psu.edu/tutorials/structural-equation-modeling-r-using-lavaan>  
Reference2: <https://stats.oarc.ucla.edu/r/seminars/rsem/>  
Reference3: <https://www.ianruginski.com/post/sem_handout7/>  
Reference4:
<https://bookdown.org/bean_jerry/using_r_for_social_work_research/structural-equation-modeling.html>  
Reference5: <https://www.lexjansen.com/wuss/2006/tutorials/TUT-Suhr.pdf>

### What is SEM

Source: in the readme file.

Structure Equation Modeling (SEM) analysis the network of relationship
between the variables (including latent constructs, and measured
variable ).

Unlike other conventional stat techniques, SES reqiures model
specification( including measurement error specification)

SES is linear statistics technique, and do not provide causality test.

Keep in mind that SES do not provide default model. SEM has a powerful
weapon- intuitive visulaization.

*Goals* 1) patterns of cov/cor among the variables 2) how much variance
can be explianed by this specificed model.

### Packages

``` r
library(lavaan)
```

    ## Warning: package 'lavaan' was built under R version 4.1.3

    ## This is lavaan 0.6-11
    ## lavaan is FREE software! Please report any bugs.

``` r
library(tidyverse)
```

    ## -- Attaching packages --------------------------------------- tidyverse 1.3.1 --

    ## v ggplot2 3.3.6     v purrr   0.3.4
    ## v tibble  3.1.4     v dplyr   1.0.8
    ## v tidyr   1.2.0     v stringr 1.4.0
    ## v readr   2.1.2     v forcats 0.5.1

    ## Warning: package 'ggplot2' was built under R version 4.1.3

    ## Warning: package 'tidyr' was built under R version 4.1.3

    ## Warning: package 'readr' was built under R version 4.1.3

    ## Warning: package 'dplyr' was built under R version 4.1.3

    ## -- Conflicts ------------------------------------------ tidyverse_conflicts() --
    ## x dplyr::filter() masks stats::filter()
    ## x dplyr::lag()    masks stats::lag()

``` r
library(psych)
```

    ## Warning: package 'psych' was built under R version 4.1.3

    ## 
    ## Attaching package: 'psych'

    ## The following objects are masked from 'package:ggplot2':
    ## 
    ##     %+%, alpha

    ## The following object is masked from 'package:lavaan':
    ## 
    ##     cor2cov

``` r
library(MASS)
```

    ## 
    ## Attaching package: 'MASS'

    ## The following object is masked from 'package:dplyr':
    ## 
    ##     select

``` r
library(mvnormalTest)
```

    ## Warning: package 'mvnormalTest' was built under R version 4.1.3

    ## 
    ## Attaching package: 'mvnormalTest'

    ## The following object is masked from 'package:psych':
    ## 
    ##     mardia

``` r
library(semPlot)
```

    ## Warning: package 'semPlot' was built under R version 4.1.3

### Simulate the data

``` r
demo.model <- '
y ~ .5*f 

f =~ .8*x1 + .8*x2 + .8*x3 + .8*x4 + .8*x5  

x1 ~~ (1-.8^2)*x1
x2 ~~ (1-.8^2)*x2
x3 ~~ (1-.8^2)*x3
x4 ~~ (1-.8^2)*x4
x5 ~~ (1-.8^2)*x5
'
simData <- lavaan::simulateData(demo.model, sample.nobs=200)

# see the describtive stats
psych::describe(simData)
```

    ##    vars   n  mean   sd median trimmed  mad   min  max range  skew kurtosis   se
    ## x1    1 200  0.03 1.00  -0.05    0.01 1.02 -1.99 3.60  5.59  0.33     0.16 0.07
    ## x2    2 200 -0.03 0.93  -0.01   -0.03 0.96 -2.10 2.35  4.45  0.06    -0.48 0.07
    ## x3    3 200  0.05 1.01   0.08    0.05 1.01 -2.49 2.50  4.99  0.00    -0.38 0.07
    ## x4    4 200  0.05 0.94   0.11    0.07 0.96 -2.47 2.30  4.77 -0.20    -0.18 0.07
    ## x5    5 200 -0.02 0.96  -0.02   -0.03 0.93 -2.29 2.83  5.12  0.17    -0.03 0.07
    ## y     6 200  0.02 1.09   0.08    0.03 1.05 -2.50 2.51  5.01 -0.10    -0.54 0.08

``` r
# multivariate nurmality test 

mv<-mardia(simData)
mv
```

    ## $mv.test
    ##           Test Statistic p-value Result
    ## 1     Skewness   60.3376  0.3219    YES
    ## 2     Kurtosis   -0.1214  0.9034    YES
    ## 3 MV Normality      <NA>    <NA>    YES
    ## 
    ## $uv.shapiro
    ##    W      p-value UV.Normality
    ## x1 0.9883 0.0999  Yes         
    ## x2 0.9934 0.508   Yes         
    ## x3 0.9951 0.7631  Yes         
    ## x4 0.9941 0.6098  Yes         
    ## x5 0.9943 0.648   Yes         
    ## y  0.9913 0.2775  Yes

``` r
#?simulateData

sim.cor <-cor(simData, use="pairwise.complete.obs", method="pearson")
sim.cor
```

    ##           x1        x2        x3        x4        x5         y
    ## x1 1.0000000 0.5848531 0.6357392 0.6744889 0.6038086 0.3348055
    ## x2 0.5848531 1.0000000 0.6325821 0.5961548 0.6001754 0.3605341
    ## x3 0.6357392 0.6325821 1.0000000 0.6706464 0.6287285 0.2938568
    ## x4 0.6744889 0.5961548 0.6706464 1.0000000 0.6290981 0.3358678
    ## x5 0.6038086 0.6001754 0.6287285 0.6290981 1.0000000 0.3842685
    ## y  0.3348055 0.3605341 0.2938568 0.3358678 0.3842685 1.0000000

### specify the model

``` r
tofit.model <- '
y ~ f 
f =~ x1+ x2 + x3 + x4 + x5 
x1 ~~ x1 
x2 ~~ x2 
x3~~x3 
x4~~x4 
x5~~x5 
'

tofit.model_m <- sem(tofit.model, simData)

summary(tofit.model_m, fit.measures=T)
```

    ## lavaan 0.6-11 ended normally after 22 iterations
    ## 
    ##   Estimator                                         ML
    ##   Optimization method                           NLMINB
    ##   Number of model parameters                        12
    ##                                                       
    ##   Number of observations                           200
    ##                                                       
    ## Model Test User Model:
    ##                                                       
    ##   Test statistic                                 7.773
    ##   Degrees of freedom                                 9
    ##   P-value (Chi-square)                           0.557
    ## 
    ## Model Test Baseline Model:
    ## 
    ##   Test statistic                               582.841
    ##   Degrees of freedom                                15
    ##   P-value                                        0.000
    ## 
    ## User Model versus Baseline Model:
    ## 
    ##   Comparative Fit Index (CFI)                    1.000
    ##   Tucker-Lewis Index (TLI)                       1.004
    ## 
    ## Loglikelihood and Information Criteria:
    ## 
    ##   Loglikelihood user model (H0)              -1395.551
    ##   Loglikelihood unrestricted model (H1)      -1391.665
    ##                                                       
    ##   Akaike (AIC)                                2815.102
    ##   Bayesian (BIC)                              2854.682
    ##   Sample-size adjusted Bayesian (BIC)         2816.665
    ## 
    ## Root Mean Square Error of Approximation:
    ## 
    ##   RMSEA                                          0.000
    ##   90 Percent confidence interval - lower         0.000
    ##   90 Percent confidence interval - upper         0.072
    ##   P-value RMSEA <= 0.05                          0.835
    ## 
    ## Standardized Root Mean Square Residual:
    ## 
    ##   SRMR                                           0.021
    ## 
    ## Parameter Estimates:
    ## 
    ##   Standard errors                             Standard
    ##   Information                                 Expected
    ##   Information saturated (h1) model          Structured
    ## 
    ## Latent Variables:
    ##                    Estimate  Std.Err  z-value  P(>|z|)
    ##   f =~                                                
    ##     x1                1.000                           
    ##     x2                0.887    0.079   11.254    0.000
    ##     x3                1.027    0.084   12.259    0.000
    ##     x4                0.966    0.078   12.409    0.000
    ##     x5                0.942    0.081   11.633    0.000
    ## 
    ## Regressions:
    ##                    Estimate  Std.Err  z-value  P(>|z|)
    ##   y ~                                                 
    ##     f                 0.583    0.099    5.910    0.000
    ## 
    ## Variances:
    ##                    Estimate  Std.Err  z-value  P(>|z|)
    ##    .x1                0.375    0.047    8.034    0.000
    ##    .x2                0.370    0.044    8.441    0.000
    ##    .x3                0.343    0.044    7.730    0.000
    ##    .x4                0.286    0.038    7.585    0.000
    ##    .x5                0.365    0.044    8.215    0.000
    ##    .y                 0.958    0.098    9.744    0.000
    ##     f                 0.628    0.097    6.471    0.000

``` r
inspect(tofit.model_m)
```

    ## $lambda
    ##    f y
    ## x1 0 0
    ## x2 2 0
    ## x3 3 0
    ## x4 4 0
    ## x5 5 0
    ## y  0 0
    ## 
    ## $theta
    ##    x1 x2 x3 x4 x5 y 
    ## x1  6               
    ## x2  0  7            
    ## x3  0  0  8         
    ## x4  0  0  0  9      
    ## x5  0  0  0  0 10   
    ## y   0  0  0  0  0  0
    ## 
    ## $psi
    ##   f  y 
    ## f 12   
    ## y  0 11
    ## 
    ## $beta
    ##   f y
    ## f 0 0
    ## y 1 0

``` r
semPlot::semPaths(tofit.model_m)
```

![](08p_files/figure-gfm/unnamed-chunk-3-1.png)<!-- -->

lavaan package’s notation

**\~ : predict** (y\~x: y is predicted by x)

**=\~ : indicator** (latent variable =\~ observed indicator)

**\~\~** Covariance

**\~1: intercept or mean ** x\~1 : mean of variable x

**1**\* fixed parameter or loading to one

**NA**\* frees parameter or loading

**a**\*labels the parameter ‘a’ for model constraints

## Simple regression

before going further, let’s try simple regression

``` r
hey<-lm(y~x2, simData)
summary(hey)
```

    ## 
    ## Call:
    ## lm(formula = y ~ x2, data = simData)
    ## 
    ## Residuals:
    ##      Min       1Q   Median       3Q      Max 
    ## -2.48928 -0.80755  0.04957  0.72180  2.52698 
    ## 
    ## Coefficients:
    ##             Estimate Std. Error t value Pr(>|t|)    
    ## (Intercept)  0.03106    0.07178   0.433    0.666    
    ## x2           0.41990    0.07720   5.439 1.57e-07 ***
    ## ---
    ## Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1
    ## 
    ## Residual standard error: 1.015 on 198 degrees of freedom
    ## Multiple R-squared:   0.13,  Adjusted R-squared:  0.1256 
    ## F-statistic: 29.58 on 1 and 198 DF,  p-value: 1.57e-07

results interpretaion:

as one unit increase in x1, the y score improves approaximatly 0.508,
and Significant. the residual standard error is 1.087. the residual
variance is (1.087)^2 = 1.181569

This can be done by Lavaan packages

``` r
hey2<-'
y ~ 1 + x2
x2~~x2
'

hey2fit<-sem(hey2,data=simData)
summary(hey2fit)
```

    ## lavaan 0.6-11 ended normally after 9 iterations
    ## 
    ##   Estimator                                         ML
    ##   Optimization method                           NLMINB
    ##   Number of model parameters                         5
    ##                                                       
    ##   Number of observations                           200
    ##                                                       
    ## Model Test User Model:
    ##                                                       
    ##   Test statistic                                 0.000
    ##   Degrees of freedom                                 0
    ## 
    ## Parameter Estimates:
    ## 
    ##   Standard errors                             Standard
    ##   Information                                 Expected
    ##   Information saturated (h1) model          Structured
    ## 
    ## Regressions:
    ##                    Estimate  Std.Err  z-value  P(>|z|)
    ##   y ~                                                 
    ##     x2                0.420    0.077    5.466    0.000
    ## 
    ## Intercepts:
    ##                    Estimate  Std.Err  z-value  P(>|z|)
    ##    .y                 0.031    0.071    0.435    0.664
    ##     x2               -0.026    0.066   -0.400    0.689
    ## 
    ## Variances:
    ##                    Estimate  Std.Err  z-value  P(>|z|)
    ##     x2                0.864    0.086   10.000    0.000
    ##    .y                 1.019    0.102   10.000    0.000

``` r
semPlot::semPaths(hey2fit)
```

![](08p_files/figure-gfm/unnamed-chunk-5-1.png)<!-- -->

results interpretaion:

the regression coifficient (0.508) is the same.

However, some difference is here. ML and OLS provide different residual
variance but the same coefficients.

## Path analysis

What is different between SEM and path analysis?

“SEM is a combination of multiple regression and factor analysis. Path
analysis deals only with measured variables. two or more measured
variables”
(Source:<https://theicph.com/wp-content/uploads/2016/09/How-to-conduct-Path-Analysis-and-SEM-for-Health-Research_24-Sep-2016_Prof-Bhisma-Murti.pdf>)
\#### Data simulation

``` r
set.seed(1234)
x<-rnorm(100)
m<-0.5*x + rnorm(100)
y<-0.7*m + rnorm(100)
data <-data.frame(x=x,m=m,y=y)
```

#### model specification

``` r
medmodel<-'
y~c*x
m~a*x
y~b*m
# indirect effect (a*b)
ab:=a*b
# total effect
total:=c+(a*b)
'
```

``` r
medmodel_m<-sem(medmodel, data=data)
summary(medmodel_m, fit.measures=T)
```

    ## lavaan 0.6-11 ended normally after 1 iterations
    ## 
    ##   Estimator                                         ML
    ##   Optimization method                           NLMINB
    ##   Number of model parameters                         5
    ##                                                       
    ##   Number of observations                           100
    ##                                                       
    ## Model Test User Model:
    ##                                                       
    ##   Test statistic                                 0.000
    ##   Degrees of freedom                                 0
    ## 
    ## Model Test Baseline Model:
    ## 
    ##   Test statistic                                84.319
    ##   Degrees of freedom                                 3
    ##   P-value                                        0.000
    ## 
    ## User Model versus Baseline Model:
    ## 
    ##   Comparative Fit Index (CFI)                    1.000
    ##   Tucker-Lewis Index (TLI)                       1.000
    ## 
    ## Loglikelihood and Information Criteria:
    ## 
    ##   Loglikelihood user model (H0)               -281.061
    ##   Loglikelihood unrestricted model (H1)       -281.061
    ##                                                       
    ##   Akaike (AIC)                                 572.122
    ##   Bayesian (BIC)                               585.148
    ##   Sample-size adjusted Bayesian (BIC)          569.357
    ## 
    ## Root Mean Square Error of Approximation:
    ## 
    ##   RMSEA                                          0.000
    ##   90 Percent confidence interval - lower         0.000
    ##   90 Percent confidence interval - upper         0.000
    ##   P-value RMSEA <= 0.05                             NA
    ## 
    ## Standardized Root Mean Square Residual:
    ## 
    ##   SRMR                                           0.000
    ## 
    ## Parameter Estimates:
    ## 
    ##   Standard errors                             Standard
    ##   Information                                 Expected
    ##   Information saturated (h1) model          Structured
    ## 
    ## Regressions:
    ##                    Estimate  Std.Err  z-value  P(>|z|)
    ##   y ~                                                 
    ##     x          (c)    0.036    0.104    0.348    0.728
    ##   m ~                                                 
    ##     x          (a)    0.474    0.103    4.613    0.000
    ##   y ~                                                 
    ##     m          (b)    0.788    0.092    8.539    0.000
    ## 
    ## Variances:
    ##                    Estimate  Std.Err  z-value  P(>|z|)
    ##    .y                 0.898    0.127    7.071    0.000
    ##    .m                 1.054    0.149    7.071    0.000
    ## 
    ## Defined Parameters:
    ##                    Estimate  Std.Err  z-value  P(>|z|)
    ##     ab                0.374    0.092    4.059    0.000
    ##     total             0.410    0.125    3.287    0.001

``` r
semPaths(medmodel_m)
```

![](08p_files/figure-gfm/unnamed-chunk-8-1.png)<!-- -->

## Confirmatory factor analysls

load the data

``` r
library(foreign)
dat <- read.spss("https://stats.idre.ucla.edu/wp-content/uploads/2018/05/SAQ.sav",
                                             to.data.frame=TRUE, use.value.labels = FALSE)
```

    ## re-encoding from UTF-8

``` r
head(dat,10)
```

    ##    q01 q02 q03 q04 q05 q06 q07 q08 q09 q10 q11 q12 q13 q14 q15 q16 q17 q18 q19
    ## 1    2   1   4   2   2   2   3   1   1   2   1   2   2   2   2   3   1   2   3
    ## 2    1   1   4   3   2   2   2   2   5   2   2   3   1   3   4   3   2   2   3
    ## 3    2   3   2   2   4   1   2   2   2   2   3   3   2   4   2   3   2   3   1
    ## 4    3   1   1   4   3   3   4   2   2   4   2   2   2   3   3   3   2   4   2
    ## 5    2   1   3   2   2   3   3   2   4   2   2   3   3   2   2   2   2   3   3
    ## 6    2   1   3   2   4   4   4   2   4   3   2   4   3   3   5   2   3   5   1
    ## 7    2   3   3   2   2   2   2   2   3   2   2   2   2   2   2   2   2   2   3
    ## 8    2   2   3   2   2   2   2   2   4   2   2   3   2   2   3   2   2   2   4
    ## 9    3   3   1   4   5   3   5   5   3   3   5   5   5   5   5   5   5   5   2
    ## 10   2   4   4   3   2   1   2   2   3   2   2   3   2   1   2   3   2   2   3
    ##    q20 q21 q22 q23
    ## 1    2   2   2   5
    ## 2    4   4   4   2
    ## 3    4   3   2   2
    ## 4    4   4   4   3
    ## 5    4   2   4   4
    ## 6    5   3   1   4
    ## 7    2   2   4   4
    ## 8    3   2   4   4
    ## 9    5   5   3   3
    ## 10   3   2   4   4

8 items, with one factor

``` r
cfa<- '
f =~ q01 + q02 + q03 + q04 + q05 + q06 + q07 + q08'

cfa8<- cfa(cfa, data=dat, std.lv=TRUE)
#std.lv=T automatically standardize the variance. 

summary(cfa8, fit.measures=T, standardized=T)
```

    ## lavaan 0.6-11 ended normally after 15 iterations
    ## 
    ##   Estimator                                         ML
    ##   Optimization method                           NLMINB
    ##   Number of model parameters                        16
    ##                                                       
    ##   Number of observations                          2571
    ##                                                       
    ## Model Test User Model:
    ##                                                       
    ##   Test statistic                               554.191
    ##   Degrees of freedom                                20
    ##   P-value (Chi-square)                           0.000
    ## 
    ## Model Test Baseline Model:
    ## 
    ##   Test statistic                              4164.572
    ##   Degrees of freedom                                28
    ##   P-value                                        0.000
    ## 
    ## User Model versus Baseline Model:
    ## 
    ##   Comparative Fit Index (CFI)                    0.871
    ##   Tucker-Lewis Index (TLI)                       0.819
    ## 
    ## Loglikelihood and Information Criteria:
    ## 
    ##   Loglikelihood user model (H0)             -26629.559
    ##   Loglikelihood unrestricted model (H1)     -26352.464
    ##                                                       
    ##   Akaike (AIC)                               53291.118
    ##   Bayesian (BIC)                             53384.751
    ##   Sample-size adjusted Bayesian (BIC)        53333.914
    ## 
    ## Root Mean Square Error of Approximation:
    ## 
    ##   RMSEA                                          0.102
    ##   90 Percent confidence interval - lower         0.095
    ##   90 Percent confidence interval - upper         0.109
    ##   P-value RMSEA <= 0.05                          0.000
    ## 
    ## Standardized Root Mean Square Residual:
    ## 
    ##   SRMR                                           0.055
    ## 
    ## Parameter Estimates:
    ## 
    ##   Standard errors                             Standard
    ##   Information                                 Expected
    ##   Information saturated (h1) model          Structured
    ## 
    ## Latent Variables:
    ##                    Estimate  Std.Err  z-value  P(>|z|)   Std.lv  Std.all
    ##   f =~                                                                  
    ##     q01               0.485    0.017   28.942    0.000    0.485    0.586
    ##     q02              -0.198    0.019  -10.633    0.000   -0.198   -0.233
    ##     q03              -0.612    0.022  -27.989    0.000   -0.612   -0.570
    ##     q04               0.632    0.019   33.810    0.000    0.632    0.667
    ##     q05               0.554    0.020   28.259    0.000    0.554    0.574
    ##     q06               0.554    0.023   23.742    0.000    0.554    0.494
    ##     q07               0.716    0.022   32.761    0.000    0.716    0.650
    ##     q08               0.424    0.018   23.292    0.000    0.424    0.486
    ## 
    ## Variances:
    ##                    Estimate  Std.Err  z-value  P(>|z|)   Std.lv  Std.all
    ##    .q01               0.450    0.015   30.734    0.000    0.450    0.656
    ##    .q02               0.685    0.019   35.300    0.000    0.685    0.946
    ##    .q03               0.780    0.025   31.157    0.000    0.780    0.675
    ##    .q04               0.499    0.018   27.989    0.000    0.499    0.555
    ##    .q05               0.623    0.020   31.040    0.000    0.623    0.670
    ##    .q06               0.951    0.029   32.711    0.000    0.951    0.756
    ##    .q07               0.702    0.024   28.678    0.000    0.702    0.578
    ##    .q08               0.581    0.018   32.849    0.000    0.581    0.764
    ##     f                 1.000                               1.000    1.000

``` r
semPaths(cfa8)
```

![](08p_files/figure-gfm/unnamed-chunk-10-1.png)<!-- -->

interpretaion

``` r
round(cor(dat[,1:8]),2)
```

    ##       q01   q02   q03   q04   q05   q06   q07   q08
    ## q01  1.00 -0.10 -0.34  0.44  0.40  0.22  0.31  0.33
    ## q02 -0.10  1.00  0.32 -0.11 -0.12 -0.07 -0.16 -0.05
    ## q03 -0.34  0.32  1.00 -0.38 -0.31 -0.23 -0.38 -0.26
    ## q04  0.44 -0.11 -0.38  1.00  0.40  0.28  0.41  0.35
    ## q05  0.40 -0.12 -0.31  0.40  1.00  0.26  0.34  0.27
    ## q06  0.22 -0.07 -0.23  0.28  0.26  1.00  0.51  0.22
    ## q07  0.31 -0.16 -0.38  0.41  0.34  0.51  1.00  0.30
    ## q08  0.33 -0.05 -0.26  0.35  0.27  0.22  0.30  1.00

q 02, it is only -.23. If we see the corr table, also can find that q02
is weakly associated with other questions. q03,
